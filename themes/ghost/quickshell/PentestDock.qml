import Quickshell
import Quickshell.Io
import QtQuick
import QtQuick.Layouts

// Ghost Mode Dock - Right side with pentest tool launcher
Panel {
    id: pentestDock
    anchors {
        top: parent.top
        bottom: parent.bottom
        right: parent.right
    }
    topMargin: 40
    bottomMargin: 8
    width: expanded ? 280 : 48
    color: "#e6000000"
    
    property bool expanded: false
    property var tools: []
    property int selectedCategory: -1
    
    // Tool categories matching blackarch
    property var categories: [
        { name: "RECON", icon: "ğŸ”", tools: [] },
        { name: "WEB", icon: "ğŸŒ", tools: [] },
        { name: "EXPLOIT", icon: "ğŸ’€", tools: [] },
        { name: "PASSWORD", icon: "ğŸ”", tools: [] },
        { name: "WIRELESS", icon: "ğŸ“¡", tools: [] },
        { name: "FORENSIC", icon: "ğŸ”¬", tools: [] }
    ]

    // Scan for installed pentest tools
    Process {
        id: scanTools
        command: ["/home/isaiah/.config/hypr/scripts/pentest-tools.sh"]
        stdout: StdioCollector {
            onContentChanged: {
                if (content.trim() !== "") {
                    try {
                        var data = JSON.parse(content.trim())
                        pentestDock.tools = data.tools || []
                        // Populate categories
                        for (var i = 0; i < pentestDock.tools.length; i++) {
                            var tool = pentestDock.tools[i]
                            for (var j = 0; j < pentestDock.categories.length; j++) {
                                if (tool.category === pentestDock.categories[j].name) {
                                    pentestDock.categories[j].tools.push(tool)
                                    break
                                }
                            }
                        }
                        // Trigger update
                        pentestDock.categoriesChanged()
                    } catch(e) {
                        console.log("Failed to parse tools: " + e)
                    }
                }
            }
        }
        Component.onCompleted: running = true
    }

    Behavior on width { NumberAnimation { duration: 150 } }

    ColumnLayout {
        anchors.fill: parent
        anchors.margins: 4
        spacing: 4

        // Expand/Collapse button
        Rectangle {
            Layout.fillWidth: true
            height: 36
            color: expandHover.hovered ? "#00ff00" : "transparent"
            border.color: "#00ff00"
            border.width: 1
            radius: 2

            Text {
                anchors.centerIn: parent
                text: pentestDock.expanded ? "â—€ TOOLS" : "â–¶"
                color: expandHover.hovered ? "#000000" : "#00ff00"
                font.family: "Monospace"
                font.bold: true
            }

            HoverHandler { id: expandHover }
            TapHandler {
                onTapped: pentestDock.expanded = !pentestDock.expanded
            }
        }

        // Categories
        Repeater {
            model: pentestDock.categories

            Rectangle {
                Layout.fillWidth: true
                height: catExpanded ? (40 + modelData.tools.length * 32) : 40
                color: "transparent"
                border.color: "#00ff00"
                border.width: 1
                radius: 2
                clip: true
                
                property bool catExpanded: pentestDock.selectedCategory === index

                Behavior on height { NumberAnimation { duration: 100 } }

                ColumnLayout {
                    anchors.fill: parent
                    spacing: 0

                    // Category header
                    Rectangle {
                        Layout.fillWidth: true
                        height: 40
                        color: catHover.hovered ? "#00ff0033" : "transparent"

                        RowLayout {
                            anchors.fill: parent
                            anchors.margins: 8
                            spacing: 8

                            Text {
                                text: modelData.icon
                                font.pixelSize: 16
                            }

                            Text {
                                visible: pentestDock.expanded
                                text: modelData.name + " (" + modelData.tools.length + ")"
                                color: "#00ff00"
                                font.family: "Monospace"
                                font.bold: true
                                font.pixelSize: 11
                                Layout.fillWidth: true
                            }
                        }

                        HoverHandler { id: catHover }
                        TapHandler {
                            onTapped: {
                                if (pentestDock.selectedCategory === index) {
                                    pentestDock.selectedCategory = -1
                                } else {
                                    pentestDock.selectedCategory = index
                                }
                            }
                        }
                    }

                    // Tools list (when category expanded)
                    Repeater {
                        model: modelData.tools

                        Rectangle {
                            visible: catExpanded && pentestDock.expanded
                            Layout.fillWidth: true
                            height: 32
                            color: toolHover.hovered ? "#00ff0044" : "transparent"

                            RowLayout {
                                anchors.fill: parent
                                anchors.leftMargin: 24
                                anchors.rightMargin: 8
                                spacing: 8

                                // GUI/CLI indicator
                                Rectangle {
                                    width: 6
                                    height: 6
                                    radius: 3
                                    color: modelData.gui ? "#00ffff" : "#ff9900"
                                }

                                Text {
                                    text: modelData.name
                                    color: "#00ff00"
                                    font.family: "Monospace"
                                    font.pixelSize: 10
                                    Layout.fillWidth: true
                                    elide: Text.ElideRight
                                }
                            }

                            HoverHandler { id: toolHover }
                            TapHandler {
                                onTapped: {
                                    if (modelData.gui) {
                                        launchProc.command = [modelData.name]
                                    } else {
                                        launchProc.command = ["kitty", "-e", modelData.name, "--help"]
                                    }
                                    launchProc.running = true
                                }
                            }
                        }
                    }
                }
            }
        }

        Item { Layout.fillHeight: true }

        // Quick launch buttons
        Rectangle {
            Layout.fillWidth: true
            height: 36
            color: burpHover.hovered ? "#ff6600" : "transparent"
            border.color: "#ff6600"
            border.width: 1
            radius: 2

            Text {
                anchors.centerIn: parent
                text: pentestDock.expanded ? "BURP SUITE" : "B"
                color: burpHover.hovered ? "#000000" : "#ff6600"
                font.family: "Monospace"
                font.bold: true
                font.pixelSize: 11
            }

            HoverHandler { id: burpHover }
            TapHandler {
                onTapped: {
                    launchProc.command = ["burpsuite"]
                    launchProc.running = true
                }
            }
        }

        Rectangle {
            Layout.fillWidth: true
            height: 36
            color: wsHover.hovered ? "#00aaff" : "transparent"
            border.color: "#00aaff"
            border.width: 1
            radius: 2

            Text {
                anchors.centerIn: parent
                text: pentestDock.expanded ? "WIRESHARK" : "W"
                color: wsHover.hovered ? "#000000" : "#00aaff"
                font.family: "Monospace"
                font.bold: true
                font.pixelSize: 11
            }

            HoverHandler { id: wsHover }
            TapHandler {
                onTapped: {
                    launchProc.command = ["wireshark"]
                    launchProc.running = true
                }
            }
        }
    }

    Process {
        id: launchProc
    }
}
